- 二叉搜索树 (BST) 在一般情况下可以均以 $O(\log_{2}n)$ 的效率进行查找, 插入和删除操作
- 但是在极端情况下, 可能导致 BST 极不平均 (如原始数据本身排列较好), 导致其操作效率退化到 $O(n)$
## AVL 树
### 定义
- 首先是一个二叉搜索树
- 在此基础上, 保证所有节点符合以下关系
$$
|左子树高度 - 右子树高度| \leq 1
$$
- **平衡因子**: $左子树高度 - 右子树高度$
对于二叉搜索树 G
![[Pasted image 20241126042054.png]]
- 根节点 10 的左子树高度 $=2$, 右子树高度 $=2$, 平衡因子 $=2-2=0 \lt 1$
- 根节点 4 的左子树高度 $=1$, 右子树高度 $=1$, 平衡因子 $=1-1=0 \lt 1$
- 根节点 17 的左子树高度 $=0$, 右子树高度 $=1$, 平衡因子 $=0-1=-1$, $|-1| \lt 1$
**因此 G 是一个 AVL 树**

---

对于二叉搜索树 T
![[Pasted image 20241126042440.png]]
- 根节点 10 的左子树高度 $=0$, 右子树高度 $=2$, 平衡因子 $=0-2=-2$, $|-2| \textcolor{red}{\gt} 1$
**因此 T 处于失衡状态**
### 性质
- 查找、插入和删除在平均和最坏情况下的时间复杂度都是 $O(\log_{2}n)$
### 对失衡搜索树的调整: AVL 旋转
### 左旋 (Left Rotation)
- 以**右子节点**为旋转轴，将右子节点提升为新的根节点；
- 原根节点下降为新根节点的**左子节点**
- 如果原根节点的右子节点已有一个左子节点（称为“**冲突节点**”），会导致**原根节点**与新根节点的左子节点冲突, 应将冲突节点调整为原根节点（新左子节点）的右子节点
##### 例
**对于失衡的二叉搜索树 S**
![[Pasted image 20241126042731.png]]
- 根节点 4 的平衡因子为 $-2$,
- 将根节点以右节点为轴左旋, 使右节点变成原根节点的新根节点, 原根节点变成新根节点的左节点
![[Pasted image 20241126043009.png]]

---

**对于失衡的二叉搜索树 F**
![[Pasted image 20241126043202.png]]
1. 根节点 $5$ 的平衡因子为负, 根节点左旋
2. 左旋后与新根节点 $9$ 的左节点**冲突**, 将冲突的左节点变为**新左节点 (原根节点) $5$ 的右节点**
![[Pasted image 20241126043515.png]]
### 右旋 (Right Rotation)
- 以**左子节点**为旋转轴，将左子节点提升为新的根节点；
- 原根节点下降为新根节点的**右子节点**
- 如果**原根节点**与新根节点的右子节点冲突, 将冲突节点调整为原根节点（新右子节点）的左子节点
##### 例
**对于失衡的二叉搜索树 D**
![[Pasted image 20241126043703.png]]
根节点 $10$ 的平衡因子为正, 根节点右旋
![[Pasted image 20241126044204.png]]

--- 

**对于失衡的二叉搜索树 B**
![[Pasted image 20241126044235.png]]
1. 根节点 $10$ 的平衡因子为正数, 右旋
2. 右旋后与 $6$ 有冲突节点 $9$, 将节点 $9$ 变为 $14$ 的左节点
![[Pasted image 20241126044412.png]]
### *左旋/右旋*操作的判断
#### LL 型
##### 情况
新插入的导致 BST 失衡的节点在失衡节点的**左子树左节点**
- **特征**: 失衡节点的平衡因子是 $2$, 失衡节点的**左节点**的平衡因子是 $1$
![[Pasted image 20241126045302.png]]
##### 应执行操作
对**失衡节点**进行**右旋**
![[Pasted image 20241126045336.png]]
#### RR 型
##### 情况
新插入的导致 BST 失衡的节点在失衡节点的**右子树右节点**
- **特征**: 失衡节点的平衡因子是 $-2$, 失衡节点的**右节点**的平衡因子是 $-1$
![[Pasted image 20241126045437.png]]
##### 应执行操作
对**失衡节点**进行**左旋**
![[Pasted image 20241126045458.png]]
#### LR 型
##### 情况
新插入的导致 BST 失衡的节点在失衡节点的**左子树右节点**
- **特征**: 失衡节点的平衡因子是 $2$, 失衡节点的**左节点**的平衡因子是 $-1$
![[Pasted image 20241126045843.png]]
##### 应执行操作
1. 对失衡节点的**左子结点**进行**左旋**
	![[Pasted image 20241126050106.png]]
1. 对**失衡节点**进行**右旋**
	![[Pasted image 20241126050140.png]]
#### RL 型
##### 情况
新插入的导致 BST 失衡的节点在失衡节点的**右子树右节点**
- **特征**: 失衡节点的平衡因子是 $-2$, 失衡节点的**右节点**的平衡因子是 $-1$
![[Pasted image 20241126050220.png]]

##### 应执行操作
1. 对失衡节点的**右子结点**进行**右旋**
	![[Pasted image 20241126050333.png]]
2. 对**失衡节点**进行**左旋**
	![[Pasted image 20241126050353.png]]
#### 总结

| **失衡类型** | **失衡节点平衡因子** | **失衡节点子节点平衡因子** |         **操作**         |
| :------: | :----------: | :-------------: | :--------------------: |
|    LL    |     $2$      |       $1$       |         右旋失衡节点         |
|    RR    |     $-2$     |      $-1$       |         左旋失衡节点         |
|    LR    |     $2$      |      $-1$       | 1. 左旋左子节点<br>2. 右旋失衡节点 |
|    RL    |     $-2$     |       $1$       | 1. 右旋右子节点<br>2. 左旋失衡节点 |
- 总结平衡因子与失衡类型的规律: **正 L 负 R**
	- $2,1 \to +,+ \to LL$
	- $2,-1 \to +,- \to LR$
### 多个节点同时失衡
#### 插入时出现
- 只需要调整离插入节点最近的失衡节点即可, 其它失衡节点会自然平衡
##### 例
插入节点为 $9$, 造成 $3,6$ 失衡
![[Pasted image 20241126051245.png]]
- 只需要调整节点 $6$
	![[Pasted image 20241126051344.png]]
#### 删除时出现
- 要对自删除节点向根节点的路径依次检查失衡并平衡
##### 例
![[Pasted image 20241126051737.png]]
1. 删除节点 5
	![[Pasted image 20241126051935.png]]
2. 从删除的节点开始检查, 发现节点 $7$ 失衡, **失衡节点**平衡因子为 $-2$ (**R**), **右节点**平衡因子为 $1$ (**L**), 为 **RL 型**失衡, 先**右旋右节点**, 再**左旋失衡节点**
	![[Pasted image 20241126051950.png]]
3. 再向上检查, 发现根节点 $11$ 失衡, **失衡节点**平衡因子为 $-2$ (**R**), **右节点**平衡因子为 $-1$ (**R**), 为 **RR 型**失衡, **左旋失衡节点**
	![[Pasted image 20241126052306.png]]
4. 完成删除操作
## 平衡二叉树的构建
1. 与二叉搜索树的构建基本相同
2. 每构建一次, 检查一次失衡, 如果有则平衡